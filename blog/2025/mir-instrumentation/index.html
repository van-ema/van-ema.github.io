<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Rust MIR Instrumentation | Emanuele's Log</title> <meta name="author" content="Emanuele Vannacci"> <meta name="description" content="How to inject calls inside MIR"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://van-ema.github.io/blog/2025/mir-instrumentation/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?6185d15ea1982787ad7f435576553d64"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Emanuele's Log</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Rust MIR Instrumentation</h1> <p class="post-meta">December 14, 2025</p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/category/rust"> <i class="fa-solid fa-tag fa-sm"></i> Rust</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="instrumenting-rust-mir-with-a-custom-compiler-driver">Instrumenting Rust MIR with a Custom Compiler Driver</h1> <p>Rust’s Mid-level Intermediate Representation (MIR) is one of the most powerful—but least documented—extension points in the compiler. If you want to observe reference creation, track memory, or build dynamic analyses, MIR is usually the right layer.</p> <p>This post explains <strong>how to instrument Rust MIR in practice</strong>, focusing on three concrete questions:</p> <ol> <li><strong>Which rustc APIs to use</strong></li> <li><strong>How to build a custom rustc driver</strong></li> <li><strong>How to link a runtime crate safely (even under LTO)</strong></li> </ol> <p>All examples are based on a working multi-crate workspace.</p> <hr> <h2 id="1-which-rustc-apis-to-use">1. Which rustc APIs to Use</h2> <h3 id="nightly-and-rustc_private">Nightly and <code class="language-plaintext highlighter-rouge">rustc_private</code> </h3> <p>MIR instrumentation is not available on stable Rust. You must use nightly and opt into rustc’s internal APIs:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![feature(rustc_private)]</span>

<span class="k">extern</span> <span class="k">crate</span> <span class="n">rustc_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">crate</span> <span class="n">rustc_interface</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">crate</span> <span class="n">rustc_middle</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">crate</span> <span class="n">rustc_mir_transform</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">crate</span> <span class="n">rustc_span</span><span class="p">;</span>
</code></pre></div></div> <h3 id="the-optimized_mir-query">The <code class="language-plaintext highlighter-rouge">optimized_mir</code> Query</h3> <p>Rustc exposes MIR through <em>queries</em>. The most useful query for instrumentation is <code class="language-plaintext highlighter-rouge">optimized_mir</code>, because it runs <strong>after MIR is built and optimized</strong>, but <strong>before</strong> codegen to LLVM.</p> <p>In a custom driver you can override this query via <code class="language-plaintext highlighter-rouge">Config::override_queries</code>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_config</span><span class="py">.override_queries</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(|</span><span class="n">_session</span><span class="p">,</span> <span class="n">queries</span><span class="p">|</span> <span class="p">{</span>
    <span class="n">queries</span><span class="py">.optimized_mir</span> <span class="o">=</span> <span class="n">CUSTOM_OPT_MIR</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div> <p>Your hook has the shape:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">CUSTOM_OPT_MIR</span><span class="p">:</span> <span class="k">for</span><span class="o">&lt;</span><span class="nv">'tcx</span><span class="o">&gt;</span> <span class="k">fn</span><span class="p">(</span><span class="n">tcx</span><span class="p">:</span> <span class="n">TyCtxt</span><span class="o">&lt;</span><span class="nv">'tcx</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">def</span><span class="p">:</span> <span class="n">LocalDefId</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">&amp;</span><span class="nv">'tcx</span> <span class="n">Body</span><span class="o">&lt;</span><span class="nv">'tcx</span><span class="o">&gt;</span> <span class="o">=</span>
    <span class="p">|</span><span class="n">tcx</span><span class="p">,</span> <span class="n">def</span><span class="p">|</span> <span class="p">{</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="nn">rustc_interface</span><span class="p">::</span><span class="n">DEFAULT_QUERY_PROVIDERS</span><span class="py">.optimized_mir</span><span class="p">)(</span><span class="n">tcx</span><span class="p">,</span> <span class="n">def</span><span class="p">)</span><span class="nf">.clone</span><span class="p">();</span>

        <span class="c1">// Your MIR instrumentation goes here.</span>
        <span class="n">MyOptimizationPass</span><span class="nf">.run_pass</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">body</span><span class="p">);</span>

        <span class="n">tcx</span><span class="py">.arena</span><span class="nf">.alloc</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="p">};</span>
</code></pre></div></div> <p>The important pattern is:</p> <ol> <li>Call the default provider (<code class="language-plaintext highlighter-rouge">DEFAULT_QUERY_PROVIDERS.optimized_mir</code>) to get rustc’s MIR.</li> <li>Clone it (you need an owned <code class="language-plaintext highlighter-rouge">Body</code> to edit).</li> <li>Modify it (insert statements/terminators, add locals, etc.).</li> <li>Allocate it in the compiler arena and return <code class="language-plaintext highlighter-rouge">&amp;'tcx Body&lt;'tcx&gt;</code>.</li> </ol> <p>If you pick an earlier query (like <code class="language-plaintext highlighter-rouge">mir_built</code>) you’ll see less optimized MIR; if you pick a later stage you may miss the chance to inject cleanly before codegen.</p> <hr> <h2 id="2-how-to-create-a-custom-rustc-driver">2. How to create a custom rustc driver</h2> <p>Rust no longer supports compiler plugins, so the standard approach is to <strong>replace <code class="language-plaintext highlighter-rouge">rustc</code></strong> with your own binary that embeds rustc and overrides queries.</p> <p>The basic structure is:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">CompilerCallbacks</span><span class="p">;</span>

<span class="k">impl</span> <span class="nn">rustc_driver</span><span class="p">::</span><span class="n">Callbacks</span> <span class="k">for</span> <span class="n">CompilerCallbacks</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">config</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="nn">rustc_interface</span><span class="p">::</span><span class="n">Config</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">config</span><span class="py">.override_queries</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(|</span><span class="n">_session</span><span class="p">,</span> <span class="n">queries</span><span class="p">|</span> <span class="p">{</span>
            <span class="n">queries</span><span class="py">.optimized_mir</span> <span class="o">=</span> <span class="n">CUSTOM_OPT_MIR</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="n">CompilerCallbacks</span><span class="p">;</span>
    <span class="nn">rustc_driver</span><span class="p">::</span><span class="nf">run_compiler</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">std</span><span class="p">::</span><span class="nn">env</span><span class="p">::</span><span class="nf">args</span><span class="p">()</span><span class="py">.collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">(),</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">callbacks</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>In practice you usually want a <strong>Cargo subcommand</strong> wrapper (<code class="language-plaintext highlighter-rouge">cargo-instrument-mir</code>) that runs <code class="language-plaintext highlighter-rouge">cargo build</code> but sets:</p> <ul> <li><code class="language-plaintext highlighter-rouge">RUSTC=/path/to/instrument-mir</code></li> </ul> <p>This makes the workflow feel like a normal Cargo command:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo instrument-mir <span class="nt">-p</span> hello <span class="nt">--release</span>
</code></pre></div></div> <hr> <h2 id="3-how-to-link-a-runtime-crate-safely-even-under-lto">3. How to link a runtime crate safely (even under LTO)</h2> <p>MIR instrumentation usually needs a <strong>runtime crate</strong> to record events (log, track pointers, update global state, etc.). The compiler pass injects calls, but those calls must resolve and the runtime must not be stripped by the linker.</p> <h3 id="31-make-rustc-able-to-see-the-runtime">3.1 Make rustc able to see the runtime</h3> <p>If your driver injects calls like <code class="language-plaintext highlighter-rouge">runtime::__injected_hook(...)</code>, you must ensure rustc can resolve the <code class="language-plaintext highlighter-rouge">runtime</code> crate. A simple way is to add <code class="language-plaintext highlighter-rouge">-L</code> and <code class="language-plaintext highlighter-rouge">--extern</code> when your driver invokes rustc:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">runtime_path</span> <span class="o">=</span> <span class="s">"/path/to/workspace/target/release"</span><span class="p">;</span>

<span class="n">args</span><span class="nf">.push</span><span class="p">(</span><span class="s">"-Zunstable-options"</span><span class="nf">.to_string</span><span class="p">());</span>
<span class="n">args</span><span class="nf">.push</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"-L{runtime_path}"</span><span class="p">));</span>
<span class="n">args</span><span class="nf">.push</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"--extern=force:runtime={runtime_path}/libruntime.rlib"</span><span class="p">));</span>
</code></pre></div></div> <p>Notes:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">-L</code> tells rustc where to find <code class="language-plaintext highlighter-rouge">libruntime.rlib</code>.</li> <li> <code class="language-plaintext highlighter-rouge">--extern=force:runtime=...</code> makes the crate available even if it is not referenced from source code.</li> </ul> <h3 id="32-keep-the-runtime-from-being-dead-stripped-especially-with-lto">3.2 Keep the runtime from being dead-stripped (especially with LTO)</h3> <p>With LTO enabled, the linker can remove crates and symbols that appear unused. Since the runtime is only referenced by injected MIR, it can look “unused” from the perspective of the normal Rust source.</p> <p>A robust pattern is to export a C ABI hook and <strong>force a reference to it</strong>:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">__injected_hook</span><span class="p">(</span><span class="n">addr</span><span class="p">:</span> <span class="nb">usize</span><span class="p">)</span> <span class="p">{</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"__injected_hook called for address: 0x{:x}"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">macro_rules!</span> <span class="n">force_runtime</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$sym:path</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">#[used]</span>
        <span class="k">static</span> <span class="n">_FORCE_RUNTIME</span><span class="p">:</span> <span class="k">fn</span><span class="p">(</span><span class="nb">usize</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$sym</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="nd">force_runtime!</span><span class="p">(</span><span class="n">__injected_hook</span><span class="p">);</span>
</code></pre></div></div> <p>This does two things:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">#[no_mangle]</code> + <code class="language-plaintext highlighter-rouge">extern "C"</code> gives you a predictable symbol.</li> <li> <code class="language-plaintext highlighter-rouge">#[used]</code> prevents the symbol from being dropped during optimization and linking.</li> </ul> <h3 id="33-use-a-stable-hook-abi">3.3 Use a stable hook ABI</h3> <p>Don’t pass typed references like <code class="language-plaintext highlighter-rouge">&amp;T</code> to the runtime hook. It’s brittle and can lead to invalid IR (especially under LTO). Instead, compute a stable representation in MIR (for example, a <code class="language-plaintext highlighter-rouge">usize</code> address) and pass that.</p> <p>On recent nightlies with strict provenance, the cast you want in MIR is typically:</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">CastKind</span><span class="p">::</span><span class="n">PointerExposeProvenance</span>
</code></pre></div></div> <p>That converts a pointer-like value into an integer address in a way that rustc/LLVM accept.</p> <hr> <h2 id="references">References</h2> <ul> <li><a href="https://jyn.dev/rustc-driver/" rel="external nofollow noopener" target="_blank">Writing a custom <code class="language-plaintext highlighter-rouge">rustc</code> driver</a></li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/provenance/">(Rust) Pointers provenance is real</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Emanuele Vannacci. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?9b43d6e67ddc7c0855b1478ee4c48c2d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>